<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        pending: '#f97316', 
                        success: '#22c55e',
                        danger: '#ef4444'
                    },
                    borderRadius: { '2xl': '1.5rem', '3xl': '2rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            font-weight: 600; 
        }
        
        .active-nav { background: #eff6ff; color: #3b82f6; border-right: 4px solid #3b82f6; }
        /* Estilo para nav m贸vil activa */
        .active-nav-mobile { color: #3b82f6; border-top: 3px solid #3b82f6; }
        
        .modal-animate { animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day-box { border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; transition: 0.2s; position: relative; min-height: 80px; }
        @media (min-width: 768px) { .day-box { min-height: 120px; } }
        
        .day-box:hover { background: #f1f5f9; }
        .day-box.today { background: #f0f9ff; }
        
        input, select, button, textarea {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        /* Ocultar scrollbar pero mantener funcionalidad */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden md:overflow-hidden flex flex-col">

    <section id="landingPage" class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-100 p-4 md:p-6">
        <div class="w-full max-w-6xl bg-white border border-slate-300 shadow-2xl flex flex-col md:flex-row overflow-y-auto md:overflow-hidden relative max-h-[95vh]">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
            <div class="md:w-1/2 bg-slate-50 flex flex-col items-center justify-center p-8 md:p-12 text-center border-b md:border-b-0 md:border-r border-slate-200">
                <div class="w-48 h-48 md:w-64 md:h-64 mb-6 md:mb-8 drop-shadow-xl">
                    <img src="https://github.com/sistemadigital/iconos/blob/main/tareas.gif?raw=true" alt="Libreta" class="w-full h-full object-contain">
                </div>
                <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 tracking-tighter mb-2">Agenda Digital</h1>
                <p class="text-primary font-bold tracking-widest uppercase text-[10px] md:text-xs bg-blue-50 px-3 py-1 mt-2 border border-blue-100">Uso exclusivo Defensor Oficial</p>
            </div>
            <div class="md:w-1/2 flex flex-col items-center justify-center p-8 md:p-12 text-center bg-white">
                <div class="mb-8 md:mb-10 space-y-4">
                    <h2 class="text-2xl md:text-4xl font-extrabold text-slate-900 leading-tight">Administra tu tiempo</h2>
                    <p class="text-slate-500 text-base md:text-lg font-medium max-w-sm mx-auto">Accede a tus tareas, eventos y reuniones en una plataforma centralizada y segura.</p>
                </div>
                <button onclick="enterApp()" class="group relative w-full max-w-xs px-8 py-4 md:py-5 bg-slate-900 text-white font-bold text-lg hover:bg-blue-600 transition-all flex items-center justify-center gap-4 shadow-xl">
                    <span>INGRESAR AHORA</span>
                    <i class="fa-solid fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                </button>
            </div>
        </div>
    </section>

    <div id="mainApp" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
        <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" preload="auto"></audio>

        <div id="personalWelcomeModal" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-[300] bg-slate-900 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 modal-animate border-2 border-slate-700 w-[90%] md:w-auto justify-center">
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm"></div>
            <div class="text-left">
                <h4 class="font-extrabold text-xs md:text-sm leading-tight">Hola, Marcelo Gustavo Ramos</h4>
            </div>
        </div>

        <aside class="w-72 bg-white shadow-2xl hidden md:flex flex-col z-20">
            <div class="p-8">
                <h3 class="text-4xl font-extrabold text-slate-900 leading-tight">Agenda</h3>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-5 py-4 rounded-xl font-bold active-nav transition-all">
                    <i class="fa-solid fa-house-chimney"></i> Panel de inicio
                </button>
                <button onclick="navigate('calendar')" id="nav-calendar" class="nav-btn w-full flex items-center gap-3 px-5 py-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all">
                    <i class="fa-solid fa-calendar-days"></i> Calendario
                </button>
                <button onclick="navigate('contacts')" id="nav-contacts" class="nav-btn w-full flex items-center gap-3 px-5 py-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all">
                    <i class="fa-solid fa-address-book"></i> Contactos
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="openModal('exitAppModal')" class="w-full flex items-center gap-3 px-5 py-4 rounded-xl font-extrabold text-red-600 hover:bg-red-50 transition-all">
                    <i class="fa-solid fa-right-from-bracket"></i> Salir
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden pb-20 md:pb-0">
            <div id="app-view" class="flex-1 overflow-y-auto p-4 md:p-10 no-scrollbar">
                
                <div id="view-dashboard" class="space-y-6 md:space-y-8">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">Panel de inicio</h2>
                            <p class="text-slate-500 text-sm font-bold">Gestiona tus pr贸ximos eventos.</p>
                        </div>
                        <button onclick="openTaskModal()" class="w-full md:w-auto bg-primary text-white px-8 py-4 rounded-2xl shadow-xl hover:scale-105 transition-transform flex items-center justify-center gap-2 font-extrabold">
                            <i class="fa-solid fa-plus"></i> Nuevo Evento
                        </button>
                    </header>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                        <div class="bg-white p-4 md:p-6 rounded-3xl border-2 border-slate-50 shadow-sm">
                            <div class="text-orange-500 bg-orange-50 w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center mb-3 md:mb-4"><i class="fa-solid fa-clock"></i></div>
                            <div class="text-slate-400 text-[9px] md:text-[11px] font-extrabold uppercase">Pendientes</div>
                            <div class="text-2xl md:text-4xl font-extrabold mt-1" id="stat-pending">0</div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-3xl border-2 border-slate-50 shadow-sm">
                            <div class="text-success bg-green-50 w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center mb-3 md:mb-4"><i class="fa-solid fa-check"></i></div>
                            <div class="text-slate-400 text-[9px] md:text-[11px] font-extrabold uppercase">Hechas</div>
                            <div class="text-2xl md:text-4xl font-extrabold mt-1" id="stat-completed">0</div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-3xl border-2 border-slate-50 shadow-sm">
                            <div class="text-primary bg-blue-50 w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center mb-3 md:mb-4"><i class="fa-solid fa-calendar"></i></div>
                            <div class="text-slate-400 text-[9px] md:text-[11px] font-extrabold uppercase">Hoy</div>
                            <div class="text-2xl md:text-4xl font-extrabold mt-1" id="stat-today">0</div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-3xl border-2 border-slate-50 shadow-sm">
                            <div class="text-slate-400 bg-slate-50 w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center mb-3 md:mb-4"><i class="fa-solid fa-users"></i></div>
                            <div class="text-slate-400 text-[9px] md:text-[11px] font-extrabold uppercase">Contactos</div>
                            <div class="text-2xl md:text-4xl font-extrabold mt-1" id="stat-contacts">0</div>
                        </div>
                    </div>

                    <div class="bg-white p-5 md:p-8 rounded-3xl border-2 shadow-sm">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                            <h3 class="font-extrabold text-lg md:text-xl text-slate-800">Agenda de Eventos</h3>
                            <select id="rangeSelector" onchange="renderDashboard()" class="w-full sm:w-auto bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-extrabold outline-none ring-2 ring-slate-100">
                                <option value="3">En tres d铆as</option>
                                <option value="7">Esta semana</option>
                                <option value="30">Este mes</option>
                            </select>
                        </div>
                        <div class="space-y-3 md:space-y-4" id="dashboard-list"></div>
                    </div>
                </div>

                <div id="view-calendar" class="hidden h-full flex flex-col bg-white rounded-3xl shadow-xl border overflow-hidden min-h-[500px]">
                    <div class="p-4 md:p-6 border-b flex justify-between items-center bg-white">
                        <div class="flex items-center gap-2 md:gap-4">
                            <h2 class="text-lg md:text-2xl font-extrabold tracking-tight" id="monthName">---</h2>
                            <button onclick="goToToday()" class="px-3 py-1.5 md:px-6 md:py-2 bg-slate-900 text-white rounded-lg md:rounded-xl text-[10px] font-extrabold uppercase">Hoy</button>
                        </div>
                        <div class="flex gap-1 md:gap-2">
                            <button onclick="changeMonth(-1)" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center border-2 rounded-xl hover:bg-slate-50"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="changeMonth(1)" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center border-2 rounded-xl hover:bg-slate-50"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 bg-slate-50 py-3 md:py-4 text-center text-[9px] md:text-[11px] font-extrabold text-slate-500 uppercase">
                        <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi茅</div><div>Jue</div><div>Vie</div><div>S谩b</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                </div>

                <div id="view-contacts" class="hidden space-y-6 md:space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Mis Contactos</h2>
                        <button onclick="openModal('contactModal')" class="w-full md:w-auto bg-success text-white px-8 py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-extrabold">
                            <i class="fa-solid fa-user-plus"></i> Nuevo Contacto
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="contacts-grid"></div>
                </div>
            </div>

            <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center py-3 z-[150] shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                <button onclick="navigate('dashboard')" id="m-nav-dashboard" class="flex flex-col items-center gap-1 text-slate-400 active-nav-mobile px-4">
                    <i class="fa-solid fa-house-chimney text-xl"></i>
                    <span class="text-[10px] font-bold">Inicio</span>
                </button>
                <button onclick="navigate('calendar')" id="m-nav-calendar" class="flex flex-col items-center gap-1 text-slate-400 px-4">
                    <i class="fa-solid fa-calendar-days text-xl"></i>
                    <span class="text-[10px] font-bold">Calendario</span>
                </button>
                <button onclick="navigate('contacts')" id="m-nav-contacts" class="flex flex-col items-center gap-1 text-slate-400 px-4">
                    <i class="fa-solid fa-address-book text-xl"></i>
                    <span class="text-[10px] font-bold">Contactos</span>
                </button>
                <button onclick="openModal('exitAppModal')" class="flex flex-col items-center gap-1 text-red-400 px-4">
                    <i class="fa-solid fa-right-from-bracket text-xl"></i>
                    <span class="text-[10px] font-bold">Salir</span>
                </button>
            </nav>
        </main>
    </div>

    <div id="contactModal" onclick="if(event.target === this) closeModal('contactModal')" class="hidden fixed inset-0 bg-slate-900/50 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm relative modal-animate max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('contactModal')" class="absolute top-5 right-5 text-slate-400">
                <i class="fa-solid fa-circle-xmark text-2xl"></i>
            </button>
            <h3 class="text-xl font-extrabold mb-6 text-center">Nuevo Contacto</h3>
            <form id="contactForm" class="space-y-4">
                <input type="text" id="c-name" placeholder="Nombre" required class="w-full bg-slate-50 rounded-xl p-4 border-2 border-slate-100 focus:border-primary outline-none">
                <input type="tel" id="c-phone" placeholder="Tel茅fono" class="w-full bg-slate-50 rounded-xl p-4 border-2 border-slate-100 focus:border-primary outline-none">
                <button type="submit" class="w-full bg-success text-white py-4 rounded-xl font-extrabold shadow-lg">Crear Contacto</button>
            </form>
        </div>
    </div>

    <div id="taskModal" class="hidden fixed inset-0 bg-slate-900/50 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden relative max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50 font-extrabold">
                <span>Formulario de Evento</span>
                <button onclick="closeModal('taskModal')"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form id="taskForm" class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="t-id">
                <div class="md:col-span-2"><label class="text-[10px] font-extrabold text-slate-400 uppercase">T铆tulo</label><input type="text" id="t-title" required class="w-full bg-slate-100 border-none rounded-xl p-4 mt-1 font-bold"></div>
                <div><label class="text-[10px] font-extrabold text-slate-400 uppercase">Fecha</label><input type="date" id="t-date" required class="w-full bg-slate-100 border-none rounded-xl p-4 mt-1 font-bold"></div>
                <div><label class="text-[10px] font-extrabold text-slate-400 uppercase">Hora</label><input type="time" id="t-time" required class="w-full bg-slate-100 border-none rounded-xl p-4 mt-1 font-bold"></div>
                <div><label class="text-[10px] font-extrabold text-slate-400 uppercase">Contacto</label><select id="t-contact" class="w-full bg-slate-100 border-none rounded-xl p-4 mt-1 font-bold"></select></div>
                <div><label class="text-[10px] font-extrabold text-slate-400 uppercase">Estado</label><select id="t-status" class="w-full bg-slate-100 border-none rounded-xl p-4 mt-1 font-bold"><option value="pending">Pendiente</option><option value="completed">Completada</option></select></div>
                <button type="submit" class="md:col-span-2 bg-primary text-white font-extrabold py-4 rounded-xl mt-4 text-lg">Guardar Evento</button>
            </form>
        </div>
    </div>

    <div id="previewTaskModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[400] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden modal-animate max-h-[90vh]">
            <div class="h-20 md:h-28 bg-gradient-to-r from-blue-700 to-indigo-800 p-6 md:p-8 flex justify-between items-start text-white">
                <span id="pt-badge" class="px-4 py-2 rounded-full text-[10px] font-extrabold uppercase bg-white/20 tracking-wider">Estado</span>
                <button onclick="closeModal('previewTaskModal')" class="text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="px-6 md:px-8 pb-8 md:pb-10 -mt-8">
                <div class="bg-white rounded-3xl p-6 md:p-8 shadow-2xl border border-slate-50">
                    <h3 id="pt-title" class="text-2xl md:text-3xl font-extrabold text-slate-900 mb-6 truncate">---</h3>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4"><i class="fa-solid fa-calendar text-primary"></i><span id="pt-date" class="font-extrabold">--/--/--</span></div>
                        <div class="flex items-center gap-4"><i class="fa-solid fa-clock text-primary"></i><span id="pt-time" class="font-extrabold">00:00</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 md:gap-4 mt-8">
                    <button id="pt-btn-edit" class="bg-slate-900 text-white py-4 rounded-xl font-extrabold text-[10px] uppercase">Editar</button>
                    <button id="pt-btn-toggle" class="bg-success text-white py-4 rounded-xl font-extrabold text-[10px] uppercase">Estado</button>
                    <button id="pt-btn-delete" class="bg-red-50 text-red-500 py-4 rounded-xl font-extrabold"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="exitAppModal" class="hidden fixed inset-0 bg-red-900/40 backdrop-blur-md z-[500] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl modal-animate p-8 md:p-10 text-center border-4 border-red-500">
            <h3 class="text-2xl font-extrabold text-slate-900">驴Cerrar Sesi贸n?</h3>
            <div class="mt-8 flex flex-col gap-3">
                <button onclick="exitToLanding()" class="w-full bg-red-600 text-white py-4 rounded-xl font-extrabold shadow-xl">S铆, salir ahora</button>
                <button onclick="closeModal('exitAppModal')" class="w-full bg-slate-100 text-slate-500 py-4 rounded-xl font-extrabold">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="welcomeAlert" class="hidden fixed top-4 right-4 left-4 md:left-auto z-[600] md:w-80 bg-white shadow-2xl rounded-2xl p-4 border-2 modal-animate">
        <div class="flex items-center gap-4">
            <div id="alertIcon" class="w-12 h-12 rounded-xl flex items-center justify-center text-xl"></div>
            <div><h4 id="alertTitle" class="font-extrabold text-sm">---</h4><p id="welcomeMsg" class="text-[11px] text-slate-600 font-bold">---</p></div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-slate-900/60 z-[600] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 text-center modal-animate">
            <h3 class="text-lg font-extrabold mb-6">驴Confirmar eliminaci贸n?</h3>
            <div class="space-y-3">
                <button id="confirmDeleteBtn" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold">Eliminar</button>
                <button onclick="closeModal('deleteConfirmModal')" class="w-full bg-slate-100 py-3 rounded-xl font-bold">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="previewContactModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[400] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl modal-animate p-10 text-center">
            <div class="w-20 h-20 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl text-slate-400"><i class="fa-solid fa-user"></i></div>
            <h3 id="pc-name" class="text-2xl font-extrabold text-slate-900">---</h3>
            <a href="#" id="pc-phone" class="block text-primary font-extrabold text-lg mt-2">---</a>
            <div class="grid grid-cols-2 gap-4 mt-10">
                <button id="pc-btn-delete" class="bg-red-50 text-red-600 py-4 rounded-xl font-extrabold text-[10px]">BORRAR</button>
                <button onclick="closeModal('previewContactModal')" class="bg-slate-100 text-slate-500 py-4 rounded-xl font-extrabold text-[10px]">CERRAR</button>
            </div>
        </div>
    </div>

    <script>
        // Mantenemos toda tu l贸gica original de Firebase y funciones
        const firebaseConfig = {
            apiKey: "AIzaSyBZZOjKInC-GpNvhyRSXWs3x6w_JQ7TtuU",
            authDomain: "agendatareas6.firebaseapp.com",
            projectId: "agendatareas6",
            storageBucket: "agendatareas6.firebasestorage.app",
            messagingSenderId: "861923763083",
            appId: "1:861923763083:web:ec9b30c50ce3fec057058e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const mainRef = db.collection('users').doc('defaultUser');

        const state = { tasks: [], contacts: [], renderDate: new Date(), deleteTarget: null, hasShownAlert: false, notifiedEvents: new Set() };

        function enterApp() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            const welcomeModal = document.getElementById('personalWelcomeModal');
            welcomeModal.classList.remove('hidden');
            setTimeout(() => welcomeModal.classList.add('hidden'), 4000);
            syncData(); 
            setInterval(checkUpcomingTasks, 60000);
        }

        function exitToLanding() {
            closeModal('exitAppModal');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            state.hasShownAlert = false;
        }

        function syncData() {
            mainRef.collection('events').onSnapshot(snap => {
                state.tasks = snap.docs.map(doc => {
                    const d = doc.data();
                    return { id: doc.id, ...d, date: d.startDate?.split('T')[0] || d.date, time: d.startDate?.split('T')[1] || d.time };
                });
                if(!state.hasShownAlert) { checkUrgentEvents(); state.hasShownAlert = true; }
                refreshUI();
            });
            mainRef.collection('contacts').onSnapshot(snap => {
                state.contacts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContacts(); updateContactSelectors(); updateStats();
            });
        }

        // Modificamos ligeramente navigate para actualizar UI m贸vil
        function navigate(v) { 
            ['dashboard', 'calendar', 'contacts'].forEach(x => { 
                document.getElementById(`view-${x}`).classList.toggle('hidden', x !== v); 
                
                // Desktop Sidebar
                document.getElementById(`nav-${x}`).classList.toggle('active-nav', x === v); 
                
                // Mobile Nav
                const mNav = document.getElementById(`m-nav-${x}`);
                if(mNav) {
                    mNav.classList.toggle('active-nav-mobile', x === v);
                    mNav.classList.toggle('text-slate-400', x !== v);
                }
            }); 
            // Cerrar scroll en m贸vil al navegar
            document.getElementById('app-view').scrollTop = 0;
        }

        function checkUpcomingTasks() {
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            state.tasks.forEach(t => {
                if(t.status === 'completed' || t.date !== todayStr) return;
                const eventTime = new Date(`${t.date}T${t.time}`);
                const diffMins = Math.round((eventTime - now) / 60000);
                if(diffMins === 10 && !state.notifiedEvents.has(t.id)) {
                    triggerAlarm(t); state.notifiedEvents.add(t.id);
                }
            });
        }

        function triggerAlarm(task) {
            document.getElementById('alarmSound').play().catch(() => {});
            const alertBox = document.getElementById('welcomeAlert');
            document.getElementById('alertTitle').innerText = "隆Evento pr贸ximo!";
            document.getElementById('welcomeMsg').innerText = `"${task.title}" inicia en 10 minutos.`;
            document.getElementById('alertIcon').className = "w-12 h-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center animate-bounce";
            alertBox.style.borderColor = "#ef4444";
            openModal('welcomeAlert');
            setTimeout(() => closeModal('welcomeAlert'), 8000);
        }

        function checkUrgentEvents() {
            const now = new Date(); now.setHours(0,0,0,0);
            const threeDayLimit = new Date(); threeDayLimit.setDate(now.getDate() + 3);
            const urgentTasks = state.tasks.filter(t => {
                if (t.status === 'completed') return false;
                const tDate = new Date(t.date + "T00:00:00");
                return tDate >= now && tDate <= threeDayLimit;
            });
            if (urgentTasks.length > 0) {
                const alertBox = document.getElementById('welcomeAlert');
                document.getElementById('alertIcon').className = "w-12 h-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center animate-pulse";
                document.getElementById('alertTitle').innerText = "隆Atenci贸n!";
                document.getElementById('welcomeMsg').innerText = `Tienes ${urgentTasks.length} eventos en los pr贸ximos 3 d铆as.`;
                alertBox.style.borderColor = "#ef4444";
                openModal('welcomeAlert');
                setTimeout(() => closeModal('welcomeAlert'), 6000);
            } else {
                checkDailySummary();
            }
        }

        function checkDailySummary() {
            const today = new Date().toLocaleDateString('en-CA');
            const tasksToday = state.tasks.filter(t => t.date === today && t.status !== 'completed');
            const alertBox = document.getElementById('welcomeAlert');
            document.getElementById('alertIcon').className = "w-12 h-12 bg-blue-50 text-primary rounded-xl flex items-center justify-center";
            document.getElementById('alertTitle').innerText = "Resumen de hoy";
            document.getElementById('welcomeMsg').innerText = tasksToday.length === 0 ? "No tienes pendientes hoy." : `Tienes ${tasksToday.length} pendientes hoy.`;
            alertBox.style.borderColor = "#3b82f6";
            openModal('welcomeAlert');
            setTimeout(() => closeModal('welcomeAlert'), 6000);
        }

        function refreshUI() { renderDashboard(); renderCalendar(); updateStats(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function goToToday() { state.renderDate = new Date(); renderCalendar(); }
        function changeMonth(d) { state.renderDate.setMonth(state.renderDate.getMonth() + d); renderCalendar(); }

        function triggerDelete(id, type) {
            state.deleteTarget = { id, type };
            openModal('deleteConfirmModal');
        }

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            const { id, type } = state.deleteTarget;
            await mainRef.collection(type === 'task' ? 'events' : 'contacts').doc(id).delete();
            closeModal('deleteConfirmModal');
            closeModal(type === 'task' ? 'previewTaskModal' : 'previewContactModal');
        };

        function showTaskPreview(id) {
            const t = state.tasks.find(x => x.id === id);
            const isP = t.status !== 'completed';
            let displayDate = '---';
            if (t.date) {
                const parts = t.date.split('-');
                displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            document.getElementById('pt-title').innerText = t.title;
            document.getElementById('pt-date').innerText = displayDate;
            document.getElementById('pt-time').innerText = t.time; 
            document.getElementById('pt-badge').innerText = isP ? "Pendiente" : "Completada";
            document.getElementById('pt-badge').className = `px-4 py-2 rounded-full text-[10px] font-extrabold uppercase ${isP ? 'bg-orange-500' : 'bg-green-500'} text-white`;
            document.getElementById('pt-btn-edit').onclick = () => { closeModal('previewTaskModal'); editTask(t.id); };
            document.getElementById('pt-btn-delete').onclick = () => triggerDelete(t.id, 'task');
            document.getElementById('pt-btn-toggle').onclick = async () => {
                await mainRef.collection('events').doc(t.id).update({ status: isP ? 'completed' : 'pending' });
                closeModal('previewTaskModal');
            };
            openModal('previewTaskModal');
        }

        function renderDashboard() {
            const list = document.getElementById('dashboard-list'); list.innerHTML = '';
            const range = parseInt(document.getElementById('rangeSelector').value);
            const now = new Date(); now.setHours(0,0,0,0);
            const limit = new Date(); limit.setDate(now.getDate() + range);
            const filtered = state.tasks.filter(t => {
                const d = new Date(t.date + "T12:00:00");
                return d >= now && d <= limit;
            }).sort((a,b) => a.date.localeCompare(b.date));
            if(filtered.length === 0) {
                list.innerHTML = `<div class="p-10 text-center text-slate-400 text-sm font-extrabold">No hay eventos pr贸ximos.</div>`;
                return;
            }
            filtered.forEach(t => {
                const isP = t.status !== 'completed';
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-4 rounded-2xl bg-white border-2 border-slate-50 shadow-sm cursor-pointer";
                div.onclick = () => showTaskPreview(t.id);
                div.innerHTML = `<div class="w-10 h-10 rounded-xl ${isP ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'} flex items-center justify-center flex-shrink-0"><i class="fa-solid ${isP ? 'fa-clock' : 'fa-check'}"></i></div><div class="flex-1 font-extrabold text-sm text-slate-800 truncate">${t.title}</div><span class="text-[9px] font-extrabold px-2 py-1 rounded-lg ${isP ? 'bg-orange-500 text-white' : 'bg-green-500 text-white'}">${isP ? 'PENDIENTE' : 'OK'}</span>`;
                list.appendChild(div);
            });
        }

        function renderCalendar() {
            const body = document.getElementById('calendar-body'); body.innerHTML = '';
            const y = state.renderDate.getFullYear(), m = state.renderDate.getMonth();
            const todayStr = new Date().toLocaleDateString('en-CA');
            document.getElementById('monthName').innerText = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(state.renderDate).toUpperCase();
            const first = new Date(y, m, 1).getDay(), total = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) body.innerHTML += `<div class="day-box bg-slate-50/30"></div>`;
            for(let d=1; d<=total; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayTasks = state.tasks.filter(t => t.date === ds);
                const div = document.createElement('div');
                div.className = `day-box p-1 md:p-3 cursor-pointer ${ds === todayStr ? 'today' : ''}`;
                div.innerHTML = `<span class="text-[10px] text-slate-400 font-extrabold">${d}</span>`;
                dayTasks.forEach(t => div.innerHTML += `<div class="text-[7px] md:text-[9px] truncate px-1 py-0.5 rounded-md mt-0.5 text-white font-extrabold ${t.status === 'completed' ? 'bg-success' : 'bg-pending'}">${t.title}</div>`);
                div.onclick = () => { if(dayTasks.length) showTaskPreview(dayTasks[0].id); else { document.getElementById('t-date').value = ds; openTaskModal(); } };
                body.appendChild(div);
            }
        }
        
        function updateStats() {
            document.getElementById('stat-pending').innerText = state.tasks.filter(t => t.status !== 'completed').length;
            document.getElementById('stat-completed').innerText = state.tasks.filter(t => t.status === 'completed').length;
            document.getElementById('stat-contacts').innerText = state.contacts.length;
            document.getElementById('stat-today').innerText = state.tasks.filter(t => t.date === new Date().toLocaleDateString('en-CA')).length;
        }

        function updateContactSelectors() {
            const s = document.getElementById('t-contact');
            s.innerHTML = '<option value="">Sin contacto</option>' + state.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function renderContacts() {
            const g = document.getElementById('contacts-grid');
            g.innerHTML = state.contacts.map(c => `
                <div class="bg-white p-6 rounded-3xl border-2 border-slate-50 shadow-sm flex items-center gap-4 cursor-pointer" onclick="showContactPreview('${c.id}')">
                    <div class="w-12 h-12 rounded-xl bg-slate-50 flex items-center justify-center text-slate-300"><i class="fa-solid fa-user text-xl"></i></div>
                    <div class="flex-1 overflow-hidden">
                        <h4 class="font-extrabold text-slate-900 truncate">${c.name}</h4>
                        <p class="text-[10px] text-primary font-bold uppercase tracking-widest">${c.phone || 'Sin n煤mero'}</p>
                    </div>
                </div>`).join('');
        }

        function showContactPreview(id) {
            const c = state.contacts.find(x => x.id === id);
            document.getElementById('pc-name').innerText = c.name;
            const phoneLink = document.getElementById('pc-phone');
            phoneLink.innerText = c.phone || "---";
            phoneLink.href = c.phone ? `tel:${c.phone}` : "#";
            document.getElementById('pc-btn-delete').onclick = () => triggerDelete(c.id, 'contact');
            openModal('previewContactModal');
        }

        function openTaskModal() { document.getElementById('taskForm').reset(); document.getElementById('t-id').value = ""; openModal('taskModal'); }
        function editTask(id) {
            const t = state.tasks.find(x => x.id === id);
            document.getElementById('t-id').value = t.id; document.getElementById('t-title').value = t.title;
            document.getElementById('t-date').value = t.date; document.getElementById('t-time').value = t.time;
            document.getElementById('t-status').value = t.status; document.getElementById('t-contact').value = t.contactId || "";
            openModal('taskModal');
        }

        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('t-id').value;
            const data = { title: document.getElementById('t-title').value, startDate: `${document.getElementById('t-date').value}T${document.getElementById('t-time').value}`, contactId: document.getElementById('t-contact').value, status: document.getElementById('t-status').value };
            id ? await mainRef.collection('events').doc(id).update(data) : await mainRef.collection('events').add(data);
            closeModal('taskModal');
        };

        document.getElementById('contactForm').onsubmit = async (e) => {
            e.preventDefault(); 
            await mainRef.collection('contacts').add({ name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value });
            closeModal('contactModal'); 
            e.target.reset();
        };
    </script>
</body>
</html>
