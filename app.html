<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SistemaDigital-app</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Fuente Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    
    <!-- Firebase Compat (KPIs) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary-blue: oklch(0.6723 0.1606 244.9955);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background-color: #f5f7fa;
            color: var(--primary-blue);
        }

        /* Encabezado superior */
        .app-header {
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid #e2e8f0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 64px;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            white-space: nowrap;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #334155;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        .menu-toggle:hover {
            background-color: #f1f5f9;
        }

        .icon-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            overflow: hidden;
            white-space: nowrap;
            max-width: 0;
            transition: max-width 0.25s ease-in-out;
            height: 100%;
        }

        .icon-container.open {
            max-width: 1200px;
            overflow-x: auto;
        }

        .icon-container a {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: transform 0.2s ease;
            height: 100%;
            padding: 0 0.25rem;
        }

        .icon-container a img {
            width: 42px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
        }

        .icon-container a:hover img {
            transform: scale(1.2);
        }

        .typewriter-text {
            display: inline-block;
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            border-right: 3px solid var(--primary-blue);
            padding-right: 4px;
            line-height: 1.2;
            letter-spacing: 0.5px;
            animation: blinkCursor 0.9s step-end infinite;
            vertical-align: middle;
            margin-left: 0.5rem;
            flex-shrink: 1;
            min-width: 20px;
            cursor: pointer;
        }

        @keyframes blinkCursor {
            0%, 100% { border-color: var(--primary-blue); }
            50% { border-color: transparent; }
        }

        .header-right-text {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: inherit;
            margin-left: auto;
            white-space: nowrap;
            padding-left: 1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-salir {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
            transition: transform 0.2s, background-color 0.2s;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .btn-salir:hover {
            background-color: #b91c1c;
            transform: scale(1.1);
        }

        .sidebar-overlay {
            position: fixed;
            top: 64px;
            left: 0;
            width: 100%;
            height: calc(100vh - 64px);
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .main-content {
            margin-top: 64px;
            height: calc(100vh - 64px);
            overflow-y: auto;
            background-image: url('https://github.com/sistemadigital/iconos/raw/main/azulfondo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #dynamicContent {
            width: 100%;
            flex: 1;
            position: relative;
            min-height: 100px;
        }

        /* Mensaje de bienvenida con texto a la derecha */
        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            animation: fadeIn 1s ease;
            background: transparent;
            padding: 20px 20px 0 20px;
            width: 100%;
        }

        .welcome-bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            justify-content: space-between;
        }

        .welcome-bar:hover {
            background: rgba(255, 255, 255, 0.85);
        }

        .left-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar-medium, .avatar-placeholder-medium {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: white;
        }

        .avatar-placeholder-medium {
            background-color: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .welcome-message {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
        }

        .sistema-digital-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
            margin-left: auto;
        }

        .user-dropdown {
            display: none;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 1.5rem;
            width: 320px;
            max-width: 90vw;
            border: 1px solid #e2e8f0;
            z-index: 1001;
            margin-top: 0.5rem;
        }

        .user-dropdown.show {
            display: block;
        }

        /* Modal de informaci√≥n de la defensoria */
        .info-modal {
            display: none;
            position: fixed;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 1.5rem;
            width: 350px;
            max-width: 90vw;
            border: 1px solid #e2e8f0;
            z-index: 1002;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            line-height: 1.5;
        }

        .info-modal.show {
            display: block;
        }

        .info-modal p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
        }

        .info-modal strong {
            color: var(--primary-blue);
            font-weight: 600;
        }

        .info-modal hr {
            margin: 1rem 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        /* Imagen izquierda (computadora 3D) - mismo tama√±o que el modal */
        .left-info-image {
            display: none;
            position: fixed;
            width: 350px;
            max-width: 90vw;
            height: auto;
            z-index: 1003;
            pointer-events: none; /* no interfiere con clics */
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .left-info-image img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .dropdown-avatar-img, .dropdown-avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-blue);
        }

        .dropdown-avatar-placeholder {
            background-color: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .avatar-options {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            justify-content: center;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            object-fit: cover;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--primary-blue);
        }

        .info-item {
            margin-bottom: 0.75rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: inherit;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item strong {
            color: inherit;
            font-weight: 600;
            display: inline-block;
            min-width: 130px;
        }

        .version-badge {
            background: #e0f2fe;
            color: inherit;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
        }

        #nameEditRow input {
            padding: 0.3rem 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.95rem;
            flex: 1;
            margin-right: 0.5rem;
        }
        #nameEditRow button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            transition: background 0.2s;
        }
        #saveNameBtn { color: #10b981; }
        #saveNameBtn:hover { background: #e9f9f1; }
        #cancelNameBtn { color: #ef4444; }
        #cancelNameBtn:hover { background: #fee2e2; }
        .edit-icon {
            cursor: pointer;
            margin-left: 8px;
            color: #64748b;
            transition: color 0.2s;
        }
        .edit-icon:hover { color: var(--primary-blue); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- IMAGEN CENTRADA M√ÅS GRANDE --- */
        .top-image-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 20px 0 10px 0;
            cursor: pointer;
        }

        .image-large {
            width: 600px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            padding: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-large img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }

        /* Contenedor KPI (centrado y tama√±o mediano) */
        .kpi-glass-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 15px;
            margin: 0 auto 20px auto;
            width: auto;
            max-width: 800px;
        }

        .kpi-wrapper {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px;
        }

        @media (max-width: 800px) {
            .kpi-wrapper {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .kpi-wrapper {
                grid-template-columns: 1fr;
            }
        }

        .kpi-box {
            background: #ffffff;
            border-radius: 12px;
            padding: 18px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
        }

        .kpi-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.1);
        }

        .kpi-icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .kpi-data {
            flex: 1;
            min-width: 0;
        }

        .kpi-data h4 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            line-height: 1.2;
        }

        .kpi-data p {
            margin: 0;
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .kpi-sub {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #6c757d;
            font-weight: 500;
        }
        .kpi-sub strong {
            color: #333;
            font-weight: 700;
        }

        .causas-style { border-color: #007bff; }
        .causas-style .kpi-icon-circle { background: #e7f4ff; color: #007bff; }
        .dictamen-style { border-color: #2563eb; }
        .dictamen-style .kpi-icon-circle { background: #f1f5f9; color: #2563eb; }
        .atencion-total { border-color: #007bff; }
        .atencion-total .kpi-icon-circle { background: #e7f4ff; color: #007bff; }
        .cal-audiencia { border-color: #3b82f6; }
        .cal-audiencia .kpi-icon-circle { background: #eff6ff; color: #3b82f6; }

        /* --- NUEVO RELOJ DIGITAL (ARRIBA DEL BUSCADOR) --- */
        .reloj-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 10px 0 5px 0;
        }

        .reloj-texto {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            padding: 0.25rem 1.5rem;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.3);
            display: inline-block;
            text-align: center;
        }

        /* Responsive m√≥vil */
        @media (max-width: 768px) {
            .welcome-message,
            .sistema-digital-text,
            .reloj-texto {
                font-size: 1.8rem;
            }
            .welcome-bar {
                padding: 0.5rem 1rem;
                gap: 0.5rem;
            }
            .left-group {
                gap: 0.5rem;
            }
            .image-large {
                width: 400px;
            }
            .kpi-glass-container {
                margin: 0 auto 10px auto;
                max-width: 95%;
            }
            .btn-salir {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            .info-modal {
                width: 300px;
            }
            /* En m√≥vil la imagen izquierda se adapta */
            .left-info-image {
                width: 300px; /* mismo ancho que el modal en m√≥vil */
            }
            .reloj-texto {
                padding: 0.2rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .image-large {
                width: 320px;
            }
            .reloj-texto {
                font-size: 1.5rem;
            }
        }

        /* Men√∫ modal en m√≥vil */
        @media (max-width: 768px) {
            .icon-container {
                all: initial;
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 280px;
                max-width: 90vw;
                max-height: 80vh;
                background: white;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                flex-direction: column;
                align-items: stretch;
                justify-content: flex-start;
                gap: 0.25rem;
                padding: 1rem 0.75rem;
                overflow-y: auto;
                border-radius: 1.5rem;
                z-index: 10000;
                pointer-events: auto;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .icon-container.open {
                display: flex;
            }

            .icon-container a {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border-radius: 0.75rem;
                text-decoration: none;
                color: var(--primary-blue);
                font-weight: 500;
                font-size: 0.95rem;
                transition: background-color 0.2s;
                cursor: pointer;
            }

            .icon-container a:hover {
                background-color: #f1f5f9;
            }

            .icon-container a img {
                width: 28px;
                height: auto;
            }

            .icon-container a::after {
                content: attr(title);
                font-size: 0.95rem;
                color: var(--primary-blue);
            }
        }

        /* ========== NUEVOS ESTILOS: BARRA DE B√öSQUEDA IA ========== */
        .ai-search-wrapper {
            width: 100%;
            max-width: 700px;
            margin: 20px auto 10px auto;
            padding: 0 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 60px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        .ai-search-wrapper:focus-within {
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
            border-color: var(--primary-blue);
        }
        .ai-search-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 16px 20px;
            font-size: 1.1rem;
            color: #1e293b;
            outline: none;
            min-width: 0;
        }
        .ai-search-input::placeholder {
            color: #64748b;
            font-weight: 400;
        }
        .ai-search-btn {
            background: var(--primary-blue);
            border: none;
            color: white;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            flex-shrink: 0;
            margin-right: 5px;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }
        .ai-search-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        .ai-search-btn i {
            font-size: 1.4rem;
        }

        /* ========== ESTILOS ASISTENTE IA (MODAL) - Ya no se usa pero se mantiene ========== */
        #modalIA {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 2000; display: none; flex-direction: column;
        }
        .ia-pantalla-completa-container {
            display: flex; flex-direction: column; height: 100%;
            max-width: 1000px; margin: 0 auto; padding: 20px;
        }
        .ia-conversacion-wrapper {
            flex: 1; overflow-y: auto; background: #f8f9fa;
            border-radius: 12px; padding: 20px; margin-bottom: 15px;
        }
        .ia-mensaje {
            padding: 15px; border-radius: 12px; max-width: 85%;
            margin-bottom: 12px; line-height: 1.5;
        }
        .ia-mensaje.usuario {
            background: #007bff; color: white; align-self: flex-end; margin-left: auto;
        }
        .ia-mensaje.asistente {
            background: white; border: 1px solid #dee2e6; align-self: flex-start;
        }
        .ia-resultado-card {
            background: white; border: 1px solid #ddd; border-left: 4px solid #007bff;
            padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .ia-resultado-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .ia-chips-container {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;
        }
        .ia-chip {
            padding: 6px 12px; background: #e7f4ff; border: 1px solid #007bff;
            border-radius: 20px; cursor: pointer; font-size: 0.85rem;
        }
        .ia-input-container-pantalla {
            display: flex; gap: 10px; align-items: center;
        }
        .ia-input-wrapper {
            flex: 1; display: flex; align-items: center;
            background: white; border: 1px solid #ced4da; border-radius: 40px; padding: 5px 5px 5px 20px;
        }
        .ia-input-wrapper input {
            flex: 1; border: none; padding: 12px 0; font-size: 1rem; outline: none;
        }
        .ia-btn-microfono {
            background: none; border: none; color: #6c757d; font-size: 1.3rem;
            padding: 0 10px; cursor: pointer; transition: color 0.2s;
        }
        .ia-btn-microfono:hover { color: #007bff; }
        .ia-btn-enviar {
            background: #007bff; color: white; border: none; border-radius: 40px;
            padding: 12px 25px; font-size: 1rem; font-weight: 600; display: flex;
            align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s;
        }
        .ia-btn-enviar:hover { background: #0056b3; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid #e9ecef;
        }
        .modal-header h2 { font-size: 1.5rem; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .ia-botones-control { display: flex; gap: 10px; }
        .button { padding: 8px 16px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .button-secondary { background: #e9ecef; color: #495057; }
        .button-secondary:hover { background: #dee2e6; }
        .button-danger { background: #dc3545; color: white; }
        .button-danger:hover { background: #c82333; }

        /* ========== MODAL DE DETALLE DEL EXPEDIENTE ========== */
        .detalle-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .detalle-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
        }
        .detalle-modal .modal-header h3 {
            font-size: 1.3rem;
            color: var(--primary-blue);
        }
        .detalle-modal .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        .detalle-modal .close-btn:hover {
            color: #dc3545;
        }
        .detalle-contenido {
            font-family: 'Inter', sans-serif;
            color: #1e293b;
        }
        .detalle-item {
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
        }
        .detalle-item strong {
            min-width: 140px;
            color: var(--primary-blue);
            font-weight: 600;
        }
        .detalle-item span {
            flex: 1;
            word-break: break-word;
        }
        .detalle-item .fecha {
            font-family: monospace;
        }
        .detalle-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(3px);
            z-index: 2500;
        }

        /* ===== MEJORAS DE RESPONSIVIDAD PARA EL ASISTENTE IA ===== */
        @media (max-width: 768px) {
            .ia-pantalla-completa-container {
                padding: 10px;
            }
            .ia-conversacion-wrapper {
                padding: 10px;
            }
            .ia-mensaje {
                max-width: 95%;
                font-size: 0.95rem;
                padding: 12px;
            }
            .modal-header h2 {
                font-size: 1.2rem;
            }
            .ia-btn-enviar {
                padding: 10px 18px;
                font-size: 0.9rem;
            }
            .ia-input-wrapper input {
                font-size: 0.95rem;
                padding: 10px 0;
            }
            .ia-chip {
                font-size: 0.8rem;
                padding: 4px 10px;
            }
        }

        @media (max-width: 480px) {
            .ia-pantalla-completa-container {
                padding: 5px;
            }
            .ia-conversacion-wrapper {
                padding: 8px;
            }
            .ia-mensaje {
                font-size: 0.9rem;
                padding: 10px;
            }
            .ia-input-container-pantalla {
                gap: 5px;
            }
            .ia-btn-enviar span {
                display: none; /* Oculta el texto "Enviar" en m√≥viles muy peque√±os */
            }
            .ia-btn-enviar i {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir men√∫">
            <i class="fas fa-bars"></i>
        </button>
        <div class="icon-container" id="iconContainer">
            <!-- 13 iconos -->
            <a href="#" title="Expedientes"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/equilibrar.gif" alt="Expedientes"></a>
            <a href="#" title="Clientes"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/cliente.gif" alt="Clientes"></a>
            <a href="#" title="Eventos agendados"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/calendario.gif" alt="Eventos"></a>
            <a href="#" title="Libros"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/dictamen.gif" alt="Libros"></a>
            <a href="#" title="Protecci√≥n"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/proteccion.gif" alt="Protecci√≥n"></a>
            <a href="#" title="Biblioteca"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/documento.gif" alt="Documento"></a>
            <a href="#" title="Notificaciones"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/notificacion.gif" alt="Notificaciones"></a>
            <a href="#" title="Organismos"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/organismos.gif" alt="Organismos"></a>
            <a href="#" title="Operador"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/operador.gif" alt="Operador"></a>
            <a href="#" title="Inasistencias y Licencias"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/licencia.gif" alt="Licencias"></a>            
            <a href="#" title="Reporte de Sistema"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/reporte.gif" alt="Reporte"></a>            
            <a href="#" title="Consultas y Turnos"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/whatsapp.gif" alt="WhatsApp"></a>
            <a href="#" title="Agenda Defensor"><img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/tareas.gif" alt="Agenda Defensor"></a>
        </div>
        <span id="typewriterSpan" class="typewriter-text"></span>
        <span id="headerRightText" class="header-right-text">Defensoria Civil y Comercial 6 Ministerio P√∫blco de Misiones</span>
        <button id="btnSalir" class="btn-salir" title="Cerrar sesi√≥n">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="main-content" id="mainContent">
        <!-- √Årea din√°mica -->
        <div id="dynamicContent"></div>

        <!-- NUEVO RELOJ DIGITAL ARRIBA DEL BUSCADOR -->
        <div class="reloj-container" id="relojContainer">
            <span id="relojSpan" class="reloj-texto"></span>
        </div>

        <!-- ========== NUEVA BARRA DE B√öSQUEDA IA (arriba de la imagen central) ========== -->
        <div class="ai-search-wrapper" id="aiSearchWrapper">
            <input type="text" class="ai-search-input" id="aiSearchInput" placeholder="Buscar en expedientes... ej: 'vencimientos esta semana' o 'Juan P√©rez'">
            <button class="ai-search-btn" id="aiSearchBtn"><i class="fas fa-search"></i></button>
        </div>

        <!-- Imagen centrada M√ÅS GRANDE -->
        <div class="top-image-container" id="imagenCentralContainer">
            <div class="image-large">
                <img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/MP.png" alt="Ministerio P√∫blico">
            </div>
        </div>

        <!-- Contenedor KPI con solo 4 indicadores -->
        <div class="kpi-glass-container">
            <div class="kpi-wrapper">
                <div class="kpi-box causas-style">
                    <div class="kpi-icon-circle"><i class=""></i></div>
                    <div class="kpi-data">
                        <h4 id="val-causas">0</h4>
                        <p>Total Causas</p>
                    </div>
                </div>
                <div class="kpi-box dictamen-style">
                    <div class="kpi-icon-circle"><i class=""></i></div>
                    <div class="kpi-data">
                        <h4 id="val-dictamenes">0</h4>
                        <p>Total Dict√°menes</p>
                    </div>
                </div>
                <div class="kpi-box cal-audiencia">
                    <div class="kpi-icon-circle"><i class=""></i></div>
                    <div class="kpi-data">
                        <h4 id="val-cal-audiencia">0</h4>
                        <p>Audiencias</p>
                        <div class="kpi-sub" id="sub-cal-audiencia">0 pendientes</div>
                    </div>
                </div>
                <div class="kpi-box atencion-total">
                    <div class="kpi-icon-circle"><i class=""></i></div>
                    <div class="kpi-data">
                        <h4 id="val-atenciones-total">0</h4>
                        <p>Total Atenciones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de informaci√≥n de la defensoria -->
        <div id="infoModal" class="info-modal">
            <p><strong>Defensor Oficial:</strong></p>
            <div>Dr. Marcelo Gustavo Ramos</div>
            <p><strong>Secretarios:</strong></p>
            <div>Dra. Patricia Soledad Riveros</div>
            <div>Dra. Alicia Mariela Corrales</div>
            <div>Dr. Enzo Luciano Magnani</div>
            <p><strong>Tel√©fono Oficial:</strong></p>
            <div>+54 376 4446700 interno 1188.</div>
            <p><strong>Whatsapp Oficial:</strong></p>
            <div>+54 376 4000000.</div>
        </div>

        <!-- Imagen izquierda (computadora 3D) -->
        <div id="leftInfoImage" class="left-info-image">
            <img src="https://raw.githubusercontent.com/sistemadigital/iconos/main/computadora-3d.png" alt="Computadora 3D">
        </div>
    </main>

    <!-- ========== MODAL ASISTENTE IA (se conserva pero con t√≠tulo modificado) ========== -->
    <div id="modalIA">
        <div class="content">
            <div class="modal-header">
                <h2>Asistente IA para b√∫squeda de causas</h2> <!-- Cambiado -->
                <div class="ia-botones-control">
                    <button id="btnNuevaConsultaIA" class="button button-secondary"><i class="fas fa-plus"></i> Nueva</button>
                    <button id="btnSalirIA" class="button button-danger"><i class="fas fa-times"></i> Salir</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="ia-pantalla-completa-container">
                    <div class="ia-conversacion-wrapper" id="iaConversacionWrapper">
                        <div class="ia-conversacion" id="iaConversacion">
                            <!-- Mensajes din√°micos -->
                        </div>
                    </div>
                    
                    <div id="iaChipsContainer" class="ia-chips-container">
                        <!-- Chips de ejemplo -->
                        <span class="ia-chip" data-chip="Vencimientos de esta semana">üìÖ Vencimientos esta semana</span>
                        <span class="ia-chip" data-chip="Causas de Juan P√©rez">üë§ Causas de Juan P√©rez</span>
                        <span class="ia-chip" data-chip="Prioridad alta">üî• Prioridad alta</span>
                        <span class="ia-chip" data-chip="√öltimas 10 causas">üìÇ √öltimas 10 causas</span>
                    </div>

                    <div class="ia-input-container-pantalla">
                        <div class="ia-input-wrapper">
                            <input type="text" id="iaPregunta" placeholder="Ej: '¬øQu√© vencimientos tengo esta semana?' o 'Buscar causas de Juan P√©rez'..." autocomplete="off">
                            <button id="btnMicrofonoIA" class="ia-btn-microfono" title="Hablar">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <button id="iaEnviar" class="ia-btn-enviar">
                            <span>Enviar</span>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAL DE DETALLE DEL EXPEDIENTE ========== -->
    <div class="detalle-overlay" id="detalleOverlay"></div>
    <div class="detalle-modal" id="detalleModal">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Detalle del Expediente</h3>
            <button class="close-btn" id="closeDetalleModal"><i class="fas fa-times"></i></button>
        </div>
        <div class="detalle-contenido" id="detalleContenido">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </div>

    <!-- Scripts existentes (sin cambios) -->
    <script>
        (function() {
            const menuToggle = document.getElementById('menuToggle');
            const iconContainer = document.getElementById('iconContainer');
            const overlay = document.getElementById('sidebarOverlay');
            const typewriterSpan = document.getElementById('typewriterSpan');
            const headerRightText = document.getElementById('headerRightText');
            const dynamicContent = document.getElementById('dynamicContent');

            const DESKTOP_TYPING = "Haz click para comenzar";
            const MOBILE_TYPING = "Bienvenido";
            const DESKTOP_RIGHT = "Defensoria Civil y Comercial 6 Ministerio P√∫blco de Misiones";
            const MOBILE_RIGHT = "Defensoria 6";

            let typingInterval = null;
            let currentIndex = 0;
            let restartTimeout = null;
            let currentFullText = DESKTOP_TYPING;
            window.isIframeActive = false;

            function clearAllTimers() {
                if (typingInterval) { clearInterval(typingInterval); typingInterval = null; }
                if (restartTimeout) { clearTimeout(restartTimeout); restartTimeout = null; }
            }

            function stopTyping(clearText = true) {
                clearAllTimers();
                if (clearText) { typewriterSpan.textContent = ''; currentIndex = 0; }
            }

            function startTyping() {
                stopTyping(true);
                if (!typewriterSpan.parentNode) return;
                typingInterval = setInterval(() => {
                    if (currentIndex < currentFullText.length) {
                        typewriterSpan.textContent += currentFullText.charAt(currentIndex);
                        currentIndex++;
                    } else {
                        stopTyping(false);
                        restartTimeout = setTimeout(startTyping, 3000);
                    }
                }, 100);
            }

            function updateResponsiveTexts() {
                const isMobile = window.innerWidth <= 768;
                const newText = isMobile ? MOBILE_TYPING : DESKTOP_TYPING;
                if (newText !== currentFullText) {
                    currentFullText = newText;
                    stopTyping(true);
                    startTyping();
                }
                headerRightText.textContent = isMobile ? MOBILE_RIGHT : DESKTOP_RIGHT;
            }

            function closeMenu() {
                iconContainer.classList.remove('open');
                overlay.classList.remove('active');
                typewriterSpan.style.display = 'inline-block';
                startTyping();
                if (window.innerWidth <= 768) {
                    document.querySelector('.app-header').style.zIndex = '20';
                }
            }

            function openMenu() {
                iconContainer.classList.add('open');
                overlay.classList.add('active');
                typewriterSpan.style.display = 'none';
                stopTyping(true);
                if (window.innerWidth <= 768) {
                    document.querySelector('.app-header').style.zIndex = '2000';
                }
            }

            function toggleMenu() {
                if (iconContainer.classList.contains('open')) closeMenu();
                else openMenu();
            }

            menuToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });
            overlay.addEventListener('click', closeMenu);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && iconContainer.classList.contains('open')) closeMenu(); });
            iconContainer.addEventListener('click', (e) => e.stopPropagation());

            updateResponsiveTexts();
            window.addEventListener('resize', updateResponsiveTexts);

            typewriterSpan.style.display = 'inline-block';
            setTimeout(startTyping, 200);
            if (iconContainer.classList.contains('open')) openMenu();

            function cargarEnPrincipal(url) {
                window.isIframeActive = true;
                dynamicContent.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allowfullscreen', 'true');
                dynamicContent.appendChild(iframe);

                // Ocultar elementos de la vista principal
                const kpiContainer = document.querySelector('.kpi-glass-container');
                if (kpiContainer) kpiContainer.style.display = 'none';
                const topImage = document.querySelector('.top-image-container');
                if (topImage) topImage.style.display = 'none';
                const aiSearch = document.querySelector('.ai-search-wrapper');
                if (aiSearch) aiSearch.style.display = 'none';
                const relojContainer = document.querySelector('.reloj-container');
                if (relojContainer) relojContainer.style.display = 'none';

                if (!window.iframeClickHandler) {
                    window.iframeClickHandler = function(e) {
                        if (window.isIframeActive && !dynamicContent.contains(e.target) &&
                            e.target.id !== 'menuToggle' && !e.target.closest('.menu-toggle') &&
                            e.target.id !== 'btnSalir' && !e.target.closest('#btnSalir') &&
                            e.target.id !== 'sidebarOverlay' && !e.target.closest('#sidebarOverlay')) {
                            if (typeof window.mostrarHome === 'function') window.mostrarHome();
                        }
                    };
                    document.addEventListener('click', window.iframeClickHandler);
                }
            }

            window.mostrarHome = function() {};

            const iconos = document.querySelectorAll('.icon-container a');
            iconos.forEach(link => {
                link.addEventListener('click', (e) => {
                    const title = link.getAttribute('title');
                    if (title === 'Expedientes' || title === 'Eventos agendados' || title === 'Libros' || title === 'Protecci√≥n') {
                        e.preventDefault();
                        closeMenu();
                        if (title === 'Expedientes') cargarEnPrincipal('tabla.html');
                        else if (title === 'Eventos agendados') cargarEnPrincipal('eventos.html');
                        else if (title === 'Libros') cargarEnPrincipal('libros.html');
                        else if (title === 'Protecci√≥n') cargarEnPrincipal('protecciones.html');
                    } else {
                        e.preventDefault();
                        if (window.innerWidth <= 768) closeMenu();
                    }
                });
            });

            // Modal de informaci√≥n de la defensoria + imagen izquierda
            const infoModal = document.getElementById('infoModal');
            const leftImage = document.getElementById('leftInfoImage');
            const imagenContainer = document.querySelector('.top-image-container');
            const imagen = document.querySelector('.image-large img');
            let infoModalOpen = false;
            let infoClickOutsideHandler = null;

            function mostrarInfoModal(event) {
                event.stopPropagation();
                // Cerrar dropdown de usuario si est√° abierto
                const userDropdown = document.getElementById('userDropdown');
                if (userDropdown && userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                    dropdownOpen = false;
                }

                const isMobile = window.innerWidth <= 768;

                // Posicionar el modal a la derecha de la imagen central si est√° visible
                if (!isMobile && imagen && imagen.offsetParent !== null) {
                    const rect = imagen.getBoundingClientRect();
                    infoModal.style.left = (rect.right + 10) + 'px';
                    infoModal.style.top = rect.top + 'px';
                    infoModal.style.transform = 'none';
                } else {
                    infoModal.style.left = '50%';
                    infoModal.style.top = '50%';
                    infoModal.style.transform = 'translate(-50%, -50%)';
                }

                infoModal.classList.add('show');

                // Mostrar la imagen izquierda solo en escritorio
                if (!isMobile) {
                    leftImage.style.display = 'block';
                    
                    // Usamos requestAnimationFrame para asegurar que el elemento ya tenga dimensiones
                    requestAnimationFrame(() => {
                        if (imagen && imagen.offsetParent !== null) {
                            const imgRect = imagen.getBoundingClientRect();
                            const leftWidth = leftImage.offsetWidth;
                            let leftPos = imgRect.left - leftWidth - 10; // 10px de separaci√≥n
                            // Evitar que se salga por la izquierda
                            if (leftPos < 10) leftPos = 10;
                            leftImage.style.left = leftPos + 'px';
                            leftImage.style.top = (imgRect.top + (imgRect.height / 2) - (leftImage.offsetHeight / 2)) + 'px';
                            leftImage.style.transform = 'none';
                        } else {
                            // Si no hay imagen central visible, posicionar a la izquierda fija
                            leftImage.style.left = '20px';
                            leftImage.style.top = '50%';
                            leftImage.style.transform = 'translateY(-50%)';
                        }
                    });
                } else {
                    // En m√≥vil aseguramos que la imagen no se muestre
                    leftImage.style.display = 'none';
                }

                infoModalOpen = true;

                // Configurar cierre al hacer clic fuera
                if (infoClickOutsideHandler) document.removeEventListener('click', infoClickOutsideHandler);
                infoClickOutsideHandler = (e) => {
                    if (!infoModal.contains(e.target) && e.target !== headerRightText && !headerRightText.contains(e.target) && e.target !== imagen && !imagen?.contains(e.target) && e.target !== imagenContainer && !imagenContainer?.contains(e.target)) {
                        infoModal.classList.remove('show');
                        leftImage.style.display = 'none';
                        infoModalOpen = false;
                        document.removeEventListener('click', infoClickOutsideHandler);
                        infoClickOutsideHandler = null;
                    }
                };
                setTimeout(() => {
                    document.addEventListener('click', infoClickOutsideHandler);
                }, 0);
            }

            // Eventos para abrir el modal + imagen
            if (headerRightText) {
                headerRightText.addEventListener('click', mostrarInfoModal);
            }
            if (imagenContainer) {
                imagenContainer.addEventListener('click', mostrarInfoModal);
            }
            if (imagen) {
                imagen.addEventListener('click', mostrarInfoModal);
            }
        })();
    </script>

    <!-- Script Firebase Auth (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBDXZYAxWsvMiMGCrPRp3EBVuU0dzuWF4M",
            authDomain: "sistemadefensoria6.firebaseapp.com",
            projectId: "sistemadefensoria6",
            storageBucket: "sistemadefensoria6.firebasestorage.app",
            messagingSenderId: "1024631392849",
            appId: "1:1024631392849:web:1dc13292e690e2ed100670"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const AVATAR_HOMBRE = 'https://github.com/sistemadigital/iconos/blob/main/hombre.png?raw=true';
        const AVATAR_MUJER = 'https://github.com/sistemadigital/iconos/blob/main/mujer.png?raw=true';

        let currentUser = null;
        let dropdownOpen = false;
        let clickOutsideHandler = null;

        function setupClickOutside(dropdownElement, barElement) {
            if (clickOutsideHandler) document.removeEventListener('click', clickOutsideHandler);
            clickOutsideHandler = (event) => {
                if (!barElement.contains(event.target) && !dropdownElement.contains(event.target)) {
                    dropdownElement.classList.remove('show');
                    dropdownOpen = false;
                }
            };
            document.addEventListener('click', clickOutsideHandler);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Desconocido';
            const date = new Date(timestamp);
            return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        }

        async function updateUserAvatar(photoURL) {
            if (!currentUser) return;
            try {
                await updateProfile(currentUser, { photoURL });
                showWelcomeMessage(currentUser);
            } catch (error) {
                console.error('Error al actualizar avatar:', error);
                alert('No se pudo cambiar la foto.');
            }
        }

        async function updateDisplayName(newName) {
            if (!currentUser || !newName.trim()) return;
            try {
                await updateProfile(currentUser, { displayName: newName.trim() });
                showWelcomeMessage(currentUser);
            } catch (error) {
                console.error('Error al actualizar nombre:', error);
                alert('No se pudo cambiar el nombre.');
            }
        }

        function showWelcomeMessage(user) {
            const dynamicContent = document.getElementById('dynamicContent');
            if (!dynamicContent) return;
            const displayName = user.displayName || user.email.split('@')[0] || 'Usuario';
            const photoURL = user.photoURL;
            const inicial = displayName.charAt(0).toUpperCase();
            const email = user.email || '';
            const creationTime = user.metadata?.creationTime ? new Date(user.metadata.creationTime) : null;
            const lastLoginAt = user.metadata?.lastLoginAt ? new Date(parseInt(user.metadata.lastLoginAt)) : null;
            const creationStr = creationTime ? formatDate(creationTime) : 'No disponible';
            const lastLoginStr = lastLoginAt ? formatDate(lastLoginAt) : 'No disponible';

            let avatarHtml = photoURL ? `<img src="${photoURL}" alt="Avatar" class="avatar-medium" id="avatarClick">` : `<div class="avatar-placeholder-medium" id="avatarClick">${inicial}</div>`;

            let dropdownHeaderHtml = '';
            let avatarOptionsHtml = '';

            if (photoURL) {
                dropdownHeaderHtml = `<div style="font-weight:600; font-size:1.2rem; margin-bottom:1rem; color:#1e293b;">Detalle de Usuario</div>`;
            } else {
                const dropdownAvatarHtml = photoURL ? `<img src="${photoURL}" alt="Avatar" class="dropdown-avatar-img">` : `<div class="dropdown-avatar-placeholder">${inicial}</div>`;
                dropdownHeaderHtml = `<div class="dropdown-avatar">${dropdownAvatarHtml}<div style="font-weight:600; color:#1e293b;">Elige un avatar</div></div>`;
                avatarOptionsHtml = `<div class="avatar-options"><img src="${AVATAR_HOMBRE}" alt="Hombre" class="avatar-option" id="avatarHombre" title="Hombre"><img src="${AVATAR_MUJER}" alt="Mujer" class="avatar-option" id="avatarMujer" title="Mujer"></div>`;
            }

            const html = `
                <div class="welcome-container" id="welcomeContainer">
                    <div class="welcome-bar" id="welcomeBar">
                        <div class="left-group">
                            ${avatarHtml}
                            <div class="welcome-message">¬°Hola ${displayName}!</div>
                        </div>
                        <span class="sistema-digital-text">Sistema Digital</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        ${dropdownHeaderHtml}
                        ${avatarOptionsHtml}
                        <div class="info-item" id="nameDisplayRow">
                            <strong>Nombre:</strong> <span id="displayNameSpan">${displayName}</span>
                            <i class="fas fa-pencil-alt edit-icon" id="editNameIcon" title="Editar nombre"></i>
                        </div>
                        <div class="info-item" id="nameEditRow" style="display:none;">
                            <strong>Nombre:</strong> <input type="text" id="nameInput" value="${displayName}" placeholder="Nombre y apellido">
                            <button id="saveNameBtn" title="Guardar"><i class="fas fa-check"></i></button>
                            <button id="cancelNameBtn" title="Cancelar"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="info-item"><strong>Correo:</strong> ${email}</div>
                        <div class="info-item"><strong>√öltimo acceso:</strong> ${lastLoginStr}</div>
                        <div class="info-item"><strong>Registro:</strong> ${creationStr}</div>
                        <div class="version-badge">Versi√≥n 2.5 IA 2026</div>
                    </div>
                </div>
            `;
            dynamicContent.innerHTML = html;

            const bar = document.getElementById('welcomeBar');
            const dropdown = document.getElementById('userDropdown');
            const avatarHombre = document.getElementById('avatarHombre');
            const avatarMujer = document.getElementById('avatarMujer');

            bar.addEventListener('click', (e) => {
                e.stopPropagation();
                // Cerrar el modal de info si est√° abierto
                const infoModal = document.getElementById('infoModal');
                if (infoModal && infoModal.classList.contains('show')) {
                    infoModal.classList.remove('show');
                    document.getElementById('leftInfoImage').style.display = 'none';
                    infoModalOpen = false;
                }
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    dropdownOpen = false;
                } else {
                    dropdown.classList.add('show');
                    dropdownOpen = true;
                    setupClickOutside(dropdown, bar);
                }
            });

            if (avatarHombre) avatarHombre.addEventListener('click', () => updateUserAvatar(AVATAR_HOMBRE));
            if (avatarMujer) avatarMujer.addEventListener('click', () => updateUserAvatar(AVATAR_MUJER));

            const nameDisplayRow = document.getElementById('nameDisplayRow');
            const nameEditRow = document.getElementById('nameEditRow');
            const editIcon = document.getElementById('editNameIcon');
            const saveBtn = document.getElementById('saveNameBtn');
            const cancelBtn = document.getElementById('cancelNameBtn');
            const nameInput = document.getElementById('nameInput');
            const displayNameSpan = document.getElementById('displayNameSpan');

            if (editIcon) {
                editIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    nameDisplayRow.style.display = 'none';
                    nameEditRow.style.display = 'flex';
                    nameInput.focus();
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newName = nameInput.value.trim();
                    if (newName && newName !== displayName) {
                        await updateDisplayName(newName);
                    } else {
                        nameDisplayRow.style.display = 'flex';
                        nameEditRow.style.display = 'none';
                    }
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    nameDisplayRow.style.display = 'flex';
                    nameEditRow.style.display = 'none';
                    nameInput.value = displayName;
                });
            }

            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveBtn.click();
                    }
                });
            }
        }

        window.mostrarHome = function() {
            if (currentUser) {
                showWelcomeMessage(currentUser);
                const kpiContainer = document.querySelector('.kpi-glass-container');
                if (kpiContainer) kpiContainer.style.display = 'block';
                const topImage = document.querySelector('.top-image-container');
                if (topImage) topImage.style.display = 'flex';
                const aiSearch = document.querySelector('.ai-search-wrapper');
                if (aiSearch) aiSearch.style.display = 'flex';
                const relojContainer = document.querySelector('.reloj-container');
                if (relojContainer) relojContainer.style.display = 'flex';
                window.isIframeActive = false;
            } else {
                window.location.href = 'index.html';
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                mostrarHome();
            } else {
                window.location.href = 'index.html';
            }
        });

        document.getElementById('btnSalir').addEventListener('click', async () => {
            try { await signOut(auth); } catch (error) { console.error('Error al cerrar sesi√≥n:', error); }
        });

        document.getElementById('typewriterSpan').addEventListener('click', () => window.mostrarHome());
    </script>

    <!-- Script de KPIs (solo 4 indicadores) -->
    <script>
        const configCausas = { apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA", authDomain: "causas-defensoria.firebaseapp.com", projectId: "causas-defensoria" };
        const configDictamenes = { apiKey: "AIzaSyCA4PlV7FpUZsRSqJaFQrCRoKyShwpPQac", authDomain: "librodictamen.firebaseapp.com", projectId: "librodictamen" };
        const configAtenciones = { apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY", authDomain: "atencion-publico-def6.firebaseapp.com", databaseURL: "https://atencion-publico-def6-default-rtdb.firebaseio.com", projectId: "atencion-publico-def6", storageBucket: "atencion-publico-def6.firebasestorage.app", messagingSenderId: "1052433106688", appId: "1:1052433106688:web:8ac3e144bcf377ac4b55e5" };

        const appCausas = firebase.initializeApp(configCausas, "causasApp");
        const appDictamenes = firebase.initializeApp(configDictamenes, "dictamenApp");
        const appAtenciones = firebase.initializeApp(configAtenciones, "atencionesApp");

        const dbCausas = appCausas.firestore();
        const dbDictamenes = appDictamenes.firestore();
        const rtdbAtenciones = appAtenciones.database();

        dbCausas.collection("causas").onSnapshot((snapshot) => {
            document.getElementById('val-causas').innerText = snapshot.size;
            let totalAudiencias = 0;
            let futurasAudiencias = 0;
            const now = new Date();

            snapshot.forEach(doc => {
                const d = doc.data();
                const toDate = (v) => {
                    if (v && typeof v.toDate === 'function') return v.toDate();
                    if (v && v.seconds) return new Date(v.seconds * 1000);
                    if (v instanceof Date) return v;
                    const parsed = new Date(v);
                    return isNaN(parsed) ? null : parsed;
                };

                const audiencias = d.audiencias;
                if (audiencias) {
                    if (Array.isArray(audiencias)) {
                        audiencias.forEach(item => {
                            let fecha = null;
                            if (item && (item.toDate || item.seconds || item instanceof Date)) fecha = toDate(item);
                            else if (item && item.fecha) fecha = toDate(item.fecha);
                            if (fecha) {
                                totalAudiencias++;
                                if (fecha > now) futurasAudiencias++;
                            }
                        });
                    } else {
                        const fecha = toDate(audiencias);
                        if (fecha) {
                            totalAudiencias++;
                            if (fecha > now) futurasAudiencias++;
                        }
                    }
                }
            });

            document.getElementById('val-cal-audiencia').innerText = totalAudiencias;
            document.getElementById('sub-cal-audiencia').innerHTML = `<strong>${futurasAudiencias}</strong> pendientes`;
        });

        dbDictamenes.collection("dictamenes").onSnapshot(snap => {
            document.getElementById('val-dictamenes').innerText = snap.size;
        });

        rtdbAtenciones.ref('atencion').on('value', (snapshot) => {
            const data = snapshot.val();
            const registros = data ? Object.values(data) : [];
            document.getElementById('val-atenciones-total').innerText = registros.length;
        }, (error) => console.error("Error en Realtime DB:", error));
    </script>

    <!-- ========== SCRIPT DEL ASISTENTE IA - VERSI√ìN MEJORADA CON B√öSQUEDA EXACTA POR NOMBRE ========== -->
    <script>
        (function() {
            // ===== VARIABLES GLOBALES =====
            window.datosCache = [];
            let datosCargados = false;
            let totalDocumentos = 0;

            // ===== CONFIGURACI√ìN FIREBASE =====
            const causasConfig = {
                apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
                authDomain: "causas-defensoria.firebaseapp.com",
                projectId: "causas-defensoria",
                storageBucket: "causas-defensoria.appspot.com",
                messagingSenderId: "186064671470",
                appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
            };

            let dbCausasIA;
            try {
                const appCausasIA = firebase.initializeApp(causasConfig, "causasAsistenteApp");
                dbCausasIA = appCausasIA.firestore();
                appCausasIA.auth().signInAnonymously().catch(e => console.warn("Auth an√≥nima fall√≥", e));
            } catch (e) {
                console.error("Error al inicializar Firebase para el asistente:", e);
            }

            // Cargar datos en tiempo real
            if (dbCausasIA) {
                dbCausasIA.collection("causas").onSnapshot((snapshot) => {
                    window.datosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    totalDocumentos = window.datosCache.length;
                    datosCargados = true;
                    console.log(`Asistente IA: ${totalDocumentos} documentos cargados`);
                }, error => console.error("Error al cargar datosCache:", error));
            }

            // ===== FUNCIONES AUXILIARES =====
            function normalizarTexto(texto) {
                return texto.toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^\w\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            function formatearValor(valor) {
                if (valor === null || valor === undefined) return '';
                if (typeof valor === 'object') {
                    if (valor.seconds) return new Date(valor.seconds * 1000).toLocaleString();
                    if (valor instanceof Date) return valor.toLocaleString();
                    return JSON.stringify(valor);
                }
                return String(valor);
            }

            // Convertir timestamp Firestore a Date local (ignorando hora)
            function timestampToDateLocal(ts) {
                if (!ts) return null;
                let date;
                if (ts.seconds) date = new Date(ts.seconds * 1000);
                else if (ts instanceof Date) date = ts;
                else return null;
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }

            // Parsear fecha desde el texto de la consulta
            function parsearFechaDesdeTexto(texto) {
                texto = texto.toLowerCase().trim();
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                
                if (texto.includes('hoy')) return hoy;
                if (texto.includes('ma√±ana')) {
                    let manana = new Date(hoy);
                    manana.setDate(hoy.getDate() + 1);
                    return manana;
                }
                if (texto.includes('ayer')) {
                    let ayer = new Date(hoy);
                    ayer.setDate(hoy.getDate() - 1);
                    return ayer;
                }

                // Buscar patrones como dd/mm/aaaa o dd-mm-aaaa
                const regex = /\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\b/;
                const match = texto.match(regex);
                if (match) {
                    let dia = parseInt(match[1], 10);
                    let mes = parseInt(match[2], 10) - 1;
                    let anio = parseInt(match[3], 10);
                    return new Date(anio, mes, dia);
                }
                return null;
            }

            // Verificar si una causa tiene una fecha (vencimiento o audiencia) que coincida con fechaObj
            function causaCoincideFecha(causa, fechaObj) {
                // Verificar vencimiento
                if (causa.vencimiento) {
                    let fechaVen = timestampToDateLocal(causa.vencimiento);
                    if (fechaVen && fechaVen.getTime() === fechaObj.getTime()) return true;
                }
                // Verificar audiencias (puede ser array o un solo valor)
                if (causa.audiencias) {
                    if (Array.isArray(causa.audiencias)) {
                        for (let aud of causa.audiencias) {
                            let fechaAud = null;
                            if (aud && (aud.seconds || aud instanceof Date)) fechaAud = timestampToDateLocal(aud);
                            else if (aud && aud.fecha) fechaAud = timestampToDateLocal(aud.fecha);
                            if (fechaAud && fechaAud.getTime() === fechaObj.getTime()) return true;
                        }
                    } else {
                        let fechaAud = timestampToDateLocal(causa.audiencias);
                        if (fechaAud && fechaAud.getTime() === fechaObj.getTime()) return true;
                    }
                }
                return false;
            }

            // Detectar si la consulta parece un nombre completo (al menos 2 palabras)
            function esPosibleNombreCompleto(texto) {
                const palabras = texto.trim().split(/\s+/);
                return palabras.length >= 2;
            }

            // B√∫squeda EXACTA por nombre: todas las palabras del nombre deben estar presentes en caratula o usuarioAsignado
            function buscarPorNombreExacto(nombre) {
                const palabrasNombre = normalizarTexto(nombre).split(/\s+/).filter(p => p.length > 1);
                if (palabrasNombre.length === 0) return [];

                return window.datosCache.filter(causa => {
                    const caratulaNorm = normalizarTexto(causa.caratula || '');
                    const usuarioNorm = normalizarTexto(causa.usuarioAsignado || '');
                    const textoCompleto = caratulaNorm + ' ' + usuarioNorm;
                    
                    // Verificar que TODAS las palabras del nombre est√©n en el texto
                    return palabrasNombre.every(palabra => textoCompleto.includes(palabra));
                });
            }

            // Filtrar causas por vencimiento en los pr√≥ximos 7 d√≠as
            function filtrarVencimientosSemana() {
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                const dentro7 = new Date(hoy);
                dentro7.setDate(hoy.getDate() + 7);
                dentro7.setHours(23,59,59,999); // hasta el final del d√≠a 7

                return window.datosCache.filter(causa => {
                    if (!causa.vencimiento) return false;
                    let fechaVen = timestampToDateLocal(causa.vencimiento);
                    if (!fechaVen) return false;
                    return fechaVen >= hoy && fechaVen <= dentro7;
                });
            }

            // Filtrar causas con audiencias en los pr√≥ximos 7 d√≠as
            function filtrarAudienciasSemana() {
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                const dentro7 = new Date(hoy);
                dentro7.setDate(hoy.getDate() + 7);
                dentro7.setHours(23,59,59,999);

                return window.datosCache.filter(causa => {
                    if (!causa.audiencias) return false;
                    const audiencias = Array.isArray(causa.audiencias) ? causa.audiencias : [causa.audiencias];
                    for (let aud of audiencias) {
                        let fechaAud = null;
                        if (aud && (aud.seconds || aud instanceof Date)) fechaAud = timestampToDateLocal(aud);
                        else if (aud && aud.fecha) fechaAud = timestampToDateLocal(aud.fecha);
                        if (fechaAud && fechaAud >= hoy && fechaAud <= dentro7) return true;
                    }
                    return false;
                });
            }

            // Contar causas por prioridad (exacta)
            function contarPrioridad(nivel) {
                const nivelNorm = normalizarTexto(nivel);
                return window.datosCache.filter(c => {
                    const p = (c.prioridad || '').toLowerCase();
                    return normalizarTexto(p) === nivelNorm;
                }).length;
            }

            // Motor de b√∫squeda principal
            function buscarEnCausasLocal(tokens, textoCompleto) {
                if (!window.datosCache || window.datosCache.length === 0) return [];

                const textoLower = textoCompleto.toLowerCase();

                // 1. Detectar si es consulta de prioridad
                if (textoLower.includes('prioridad alta')) {
                    const cantidad = contarPrioridad('alta');
                    return { tipo: 'prioridad', nivel: 'alta', cantidad };
                }
                if (textoLower.includes('prioridad media')) {
                    const cantidad = contarPrioridad('media');
                    return { tipo: 'prioridad', nivel: 'media', cantidad };
                }
                if (textoLower.includes('prioridad baja')) {
                    const cantidad = contarPrioridad('baja');
                    return { tipo: 'prioridad', nivel: 'baja', cantidad };
                }

                // 2. Detectar si es consulta de vencimientos de la semana
                if (textoLower.includes('vencimientos') && textoLower.includes('semana')) {
                    const resultados = filtrarVencimientosSemana();
                    return { tipo: 'lista', resultados };
                }

                // 3. Detectar si es consulta de audiencias de la semana
                if (textoLower.includes('audiencias') && textoLower.includes('semana')) {
                    const resultados = filtrarAudienciasSemana();
                    return { tipo: 'lista', resultados };
                }

                // 4. Si es posible nombre completo, hacer b√∫squeda exacta
                if (esPosibleNombreCompleto(textoCompleto)) {
                    const exactos = buscarPorNombreExacto(textoCompleto);
                    if (exactos.length > 0) {
                        return { tipo: 'lista', resultados: exactos };
                    }
                    // Si no hay exactos, continuar con scoring
                }

                // 5. B√∫squeda por scoring (solo si no se encontraron exactos)
                let resultadosConPuntaje = [];
                window.datosCache.forEach(causa => {
                    let score = 0;
                    const dataString = JSON.stringify(causa).toLowerCase();
                    const dataNormalized = normalizarTexto(dataString);

                    tokens.forEach(token => {
                        const tokenNorm = normalizarTexto(token);
                        if (dataNormalized.includes(tokenNorm)) score += 10;
                    });

                    // Bonus por prioridad alta
                    if (causa.prioridad && normalizarTexto(causa.prioridad).includes('alta')) score += 5;
                    
                    // Bonus por vencimiento si la consulta menciona "vencimiento"
                    if (textoCompleto.includes('vencimiento') && causa.vencimiento) score += 15;
                    
                    // Bonus si la consulta menciona "semana" y hay vencimiento en los pr√≥ximos 7 d√≠as
                    if (textoCompleto.includes('semana') && causa.vencimiento) {
                        let venc = timestampToDateLocal(causa.vencimiento);
                        if (venc) {
                            let hoy = new Date();
                            hoy.setHours(0,0,0,0);
                            let diff = (venc - hoy) / (1000 * 60 * 60 * 24);
                            if (diff >= 0 && diff <= 7) score += 20;
                        }
                    }

                    if (score > 0) resultadosConPuntaje.push({ causa, score });
                });

                const ordenados = resultadosConPuntaje.sort((a, b) => b.score - a.score).map(item => item.causa);
                return { tipo: 'lista', resultados: ordenados.slice(0, 10) };
            }

            // Generar HTML de resultados (cards)
            function generarHTMLResultados(resultados) {
                let html = '<div>';
                resultados.forEach(causa => {
                    const numCausa = causa.numCausa || 'N/A';
                    const caratula = causa.caratula || 'Sin car√°tula';
                    const usuario = causa.usuarioAsignado || 'No asignado';
                    const prioridad = causa.prioridad || 'Media';
                    
                    let vencimiento = 'Sin fecha';
                    if (causa.vencimiento) {
                        if (causa.vencimiento.seconds) {
                            vencimiento = new Date(causa.vencimiento.seconds * 1000).toLocaleDateString();
                        } else if (causa.vencimiento instanceof Date) {
                            vencimiento = causa.vencimiento.toLocaleDateString();
                        } else if (typeof causa.vencimiento === 'string') {
                            vencimiento = causa.vencimiento;
                        }
                    }
                    
                    const causaJson = JSON.stringify(causa).replace(/"/g, '&quot;');
                    
                    html += `
                        <div class="ia-resultado-card" data-causa='${causaJson}'>
                            <strong>Expediente N¬∞: ${numCausa}</strong><br>
                            <span>Car√°tula: ${caratula}</span><br>
                            <span>Usuario: ${usuario}</span><br>
                            <small>Prioridad: ${prioridad} | Vence: ${vencimiento}</small>
                        </div>
                    `;
                });
                html += '</div>';
                return html;
            }

            // Mostrar detalle del expediente (solo campos solicitados)
            function mostrarDetalleExpediente(causa) {
                const camposPermitidos = [
                    'numCausa', 'caratula', 'tipoProceso', 'juzgado', 'estado',
                    'usuarioAsignado', 'fechaRegistro', 'intervencion', 'datosNnya', 'Audiencias'
                ];
                
                let html = '';
                camposPermitidos.forEach(campo => {
                    let valor = causa[campo];
                    if (campo === 'Audiencias' && valor) {
                        // Formatear audiencias como lista de fechas
                        if (Array.isArray(valor)) {
                            valor = valor.map(v => {
                                if (v && v.seconds) return new Date(v.seconds * 1000).toLocaleString();
                                if (v instanceof Date) return v.toLocaleString();
                                return v;
                            }).join('; ');
                        } else if (valor && valor.seconds) {
                            valor = new Date(valor.seconds * 1000).toLocaleString();
                        }
                    } else if (campo === 'fechaRegistro' && valor) {
                        if (valor.seconds) valor = new Date(valor.seconds * 1000).toLocaleString();
                        else if (valor instanceof Date) valor = valor.toLocaleString();
                    }
                    
                    let valorMostrar = valor !== undefined && valor !== null ? String(valor) : 'N/A';
                    html += `
                        <div class="detalle-item">
                            <strong>${campo}:</strong>
                            <span>${valorMostrar}</span>
                        </div>
                    `;
                });
                
                document.getElementById('detalleContenido').innerHTML = html;
                document.getElementById('detalleModal').style.display = 'block';
                document.getElementById('detalleOverlay').style.display = 'block';
            }

            // Cerrar modal de detalle
            function cerrarDetalleModal() {
                document.getElementById('detalleModal').style.display = 'none';
                document.getElementById('detalleOverlay').style.display = 'none';
            }

            // Asignar eventos a las tarjetas de resultado
            function asignarEventosTarjetas(contenedor) {
                if (!contenedor) contenedor = document;
                const tarjetas = contenedor.querySelectorAll('.ia-resultado-card');
                tarjetas.forEach(tarjeta => {
                    tarjeta.addEventListener('click', (e) => {
                        const causaData = tarjeta.getAttribute('data-causa');
                        if (causaData) {
                            try {
                                const causa = JSON.parse(causaData);
                                mostrarDetalleExpediente(causa);
                            } catch (error) {
                                console.error("Error al parsear causa:", error);
                            }
                        }
                    });
                });
            }

            // Agregar mensaje al chat (gen√©rico)
            function agregarMensaje(contenedor, tipo, contenido) {
                const div = document.createElement('div');
                div.className = `ia-mensaje ${tipo}`;
                div.innerHTML = contenido;
                contenedor.appendChild(div);
                contenedor.scrollTop = contenedor.scrollHeight;
            }

            // Procesar consulta con input y contenedor espec√≠ficos
            function procesarConsulta(inputElement, contenedorMensajes) {
                const texto = inputElement.value.trim();
                if (!texto) return;

                agregarMensaje(contenedorMensajes, 'usuario', texto);
                inputElement.value = '';

                if (!datosCargados || window.datosCache.length === 0) {
                    agregarMensaje(contenedorMensajes, 'asistente', '‚è≥ Cargando base de datos, por favor espera unos segundos e intenta de nuevo.');
                    return;
                }

                const textoLower = texto.toLowerCase();
                const tokens = textoLower.split(/\s+/).filter(t => t.length > 2);
                let resultado = buscarEnCausasLocal(tokens, textoLower);

                if (resultado.tipo === 'prioridad') {
                    agregarMensaje(contenedorMensajes, 'asistente', `Hay ${resultado.cantidad} causas con prioridad ${resultado.nivel}.`);
                } else if (resultado.tipo === 'lista') {
                    if (resultado.resultados.length > 0) {
                        let respuestaHTML = `He encontrado ${resultado.resultados.length} expedientes relacionados:<br>`;
                        respuestaHTML += generarHTMLResultados(resultado.resultados);
                        agregarMensaje(contenedorMensajes, 'asistente', respuestaHTML);
                        setTimeout(() => asignarEventosTarjetas(contenedorMensajes), 100);
                    } else {
                        agregarMensaje(contenedorMensajes, 'asistente', 'No encontr√© expedientes que coincidan exactamente con tu b√∫squeda. Prueba con otras palabras o usa los chips de ejemplo.');
                    }
                }
            }

            // ===== VISTA PRINCIPAL DEL CHAT (ocupa toda la pantalla) =====
            function mostrarChatPrincipal(textoInicial) {
                // Ocultar elementos de la p√°gina de inicio
                document.querySelector('.kpi-glass-container').style.display = 'none';
                document.querySelector('.top-image-container').style.display = 'none';
                document.querySelector('.ai-search-wrapper').style.display = 'none';
                document.querySelector('.reloj-container').style.display = 'none';
                
                // Crear estructura del chat en #dynamicContent
                const dynamicContent = document.getElementById('dynamicContent');
                dynamicContent.innerHTML = `
                    <div class="ia-pantalla-completa-container" style="height: 100%; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2>Asistente IA para b√∫squeda de causas</h2>
                            <button id="btnVolverInicio" class="button button-secondary"><i class="fas fa-home"></i> Volver al inicio</button>
                        </div>
                        <div class="ia-conversacion-wrapper" id="chatPrincipalWrapper" style="flex:1; overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div class="ia-conversacion" id="chatPrincipalConversacion"></div>
                        </div>
                        <div class="ia-chips-container" id="chatPrincipalChips">
                            <span class="ia-chip" data-chip="Vencimientos de esta semana">üìÖ Vencimientos esta semana</span>
                            <span class="ia-chip" data-chip="Causas de Juan P√©rez">üë§ Causas de Juan P√©rez</span>
                            <span class="ia-chip" data-chip="Prioridad alta">üî• Prioridad alta</span>
                            <span class="ia-chip" data-chip="√öltimas 10 causas">üìÇ √öltimas 10 causas</span>
                        </div>
                        <div class="ia-input-container-pantalla">
                            <div class="ia-input-wrapper">
                                <input type="text" id="chatPrincipalInput" placeholder="Ej: '¬øQu√© vencimientos tengo esta semana?' o 'Buscar causas de Juan P√©rez'..." autocomplete="off">
                                <button id="chatPrincipalMicrofono" class="ia-btn-microfono" title="Hablar">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <button id="chatPrincipalEnviar" class="ia-btn-enviar">
                                <span>Enviar</span>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Referencias a los nuevos elementos
                const conversacion = document.getElementById('chatPrincipalConversacion');
                const input = document.getElementById('chatPrincipalInput');
                const btnEnviar = document.getElementById('chatPrincipalEnviar');
                const btnMicro = document.getElementById('chatPrincipalMicrofono');
                const chips = document.getElementById('chatPrincipalChips');
                const btnVolver = document.getElementById('btnVolverInicio');

                // Mensaje inicial
                if (textoInicial && textoInicial.trim() !== '') {
                    input.value = textoInicial;
                    procesarConsulta(input, conversacion);
                } else {
                    if (datosCargados) {
                        agregarMensaje(conversacion, 'asistente', `Hola, soy tu asistente. Tengo ${totalDocumentos} expedientes cargados. ¬øQu√© deseas consultar?`);
                    } else {
                        agregarMensaje(conversacion, 'asistente', 'Hola, estoy cargando la base de datos... espera un momento.');
                    }
                }

                // Eventos
                btnEnviar.addEventListener('click', () => procesarConsulta(input, conversacion));
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        procesarConsulta(input, conversacion);
                    }
                });
                btnMicro.addEventListener('click', () => alert('Funcionalidad de voz no implementada.'));
                chips.addEventListener('click', (e) => {
                    const chip = e.target.closest('.ia-chip');
                    if (chip) {
                        const texto = chip.getAttribute('data-chip') || chip.innerText.replace(/[üìÖüë§üî•üìÇ]/g, '').trim();
                        input.value = texto;
                        procesarConsulta(input, conversacion);
                    }
                });
                btnVolver.addEventListener('click', () => window.mostrarHome());
            }

            // ===== EVENTOS DE LA BARRA DE B√öSQUEDA SUPERIOR =====
            document.getElementById('aiSearchBtn').addEventListener('click', () => {
                const texto = document.getElementById('aiSearchInput').value.trim();
                mostrarChatPrincipal(texto);
            });
            document.getElementById('aiSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const texto = e.target.value.trim();
                    mostrarChatPrincipal(texto);
                }
            });

            // ===== CONFIGURACI√ìN DEL MODAL IA (se mantiene pero con t√≠tulo cambiado) =====
            document.getElementById('btnNuevaConsultaIA').addEventListener('click', () => {
                document.getElementById('iaConversacion').innerHTML = '';
                document.getElementById('iaPregunta').value = '';
                if (datosCargados) {
                    agregarMensaje(document.getElementById('iaConversacion'), 'asistente', `Nueva consulta. Tengo ${totalDocumentos} expedientes.`);
                }
            });
            document.getElementById('btnSalirIA').addEventListener('click', () => {
                document.getElementById('modalIA').style.display = 'none';
            });
            document.getElementById('iaEnviar').addEventListener('click', () => {
                procesarConsulta(document.getElementById('iaPregunta'), document.getElementById('iaConversacion'));
            });
            document.getElementById('iaPregunta').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    procesarConsulta(document.getElementById('iaPregunta'), document.getElementById('iaConversacion'));
                }
            });
            document.getElementById('btnMicrofonoIA').addEventListener('click', () => alert('Funcionalidad de voz no implementada.'));
            document.getElementById('iaChipsContainer').addEventListener('click', (e) => {
                const chip = e.target.closest('.ia-chip');
                if (chip) {
                    const texto = chip.getAttribute('data-chip') || chip.innerText.replace(/[üìÖüë§üî•üìÇ]/g, '').trim();
                    document.getElementById('iaPregunta').value = texto;
                    procesarConsulta(document.getElementById('iaPregunta'), document.getElementById('iaConversacion'));
                }
            });

            // ===== MODAL DE DETALLE =====
            document.getElementById('closeDetalleModal').addEventListener('click', cerrarDetalleModal);
            document.getElementById('detalleOverlay').addEventListener('click', cerrarDetalleModal);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('detalleModal').style.display === 'block') {
                    cerrarDetalleModal();
                }
            });

            // Exponer funciones globales para uso externo (por si acaso)
            window.asistente = {
                buscar: buscarEnCausasLocal,
                mostrarDetalle: mostrarDetalleExpediente
            };
        })();
    </script>

    <!-- Script para el reloj en tiempo real -->
    <script>
        (function() {
            function actualizarReloj() {
                const relojSpan = document.getElementById('relojSpan');
                if (relojSpan) {
                    const ahora = new Date();
                    const dia = ahora.getDate().toString().padStart(2, '0');
                    const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
                    const anio = ahora.getFullYear();
                    const horas = ahora.getHours().toString().padStart(2, '0');
                    const minutos = ahora.getMinutes().toString().padStart(2, '0');
                    const segundos = ahora.getSeconds().toString().padStart(2, '0');
                    relojSpan.textContent = `${dia}/${mes}/${anio} ${horas}:${minutos}:${segundos}`;
                }
            }
            actualizarReloj();
            setInterval(actualizarReloj, 1000);
        })();
    </script>
</body>
</html>